<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kafka Observability Platform - Semiotic Intelligence Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            overflow-x: hidden;
        }

        .header {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .header .subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 4px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 16px;
            border-radius: 20px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ef4444;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #10b981;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        }

        .card h3 {
            font-size: 18px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge.observe { background: #3b82f6; }
        .badge.orient { background: #8b5cf6; }
        .badge.decide { background: #f59e0b; }
        .badge.act { background: #10b981; }
        .badge.healthy { background: #10b981; }
        .badge.degraded { background: #f59e0b; }
        .badge.critical { background: #ef4444; }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 12px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .metric-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }

        .metric-value {
            font-size: 20px;
            font-weight: 600;
        }

        .activity-stream {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 24px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .activity-stream h2 {
            font-size: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .activity-item {
            padding: 12px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-left: 4px solid #3b82f6;
            border-radius: 6px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .activity-item.orient { border-left-color: #8b5cf6; }
        .activity-item.decide { border-left-color: #f59e0b; }
        .activity-item.act { border-left-color: #10b981; }

        .activity-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .activity-time {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
        }

        .activity-details {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
            margin-top: 6px;
        }

        .scenarios {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 24px;
            margin-top: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .scenarios h2 {
            font-size: 20px;
            margin-bottom: 20px;
        }

        .scenario-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .scenario-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            padding: 16px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .scenario-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.02);
        }

        .scenario-btn:active {
            transform: scale(0.98);
        }

        .scenario-btn.running {
            background: rgba(239, 68, 68, 0.3);
            border-color: #ef4444;
            animation: pulse 2s infinite;
        }

        .ooda-flow {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .ooda-stage {
            text-align: center;
            flex: 1;
        }

        .ooda-stage-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            margin: 0 auto 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 3px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s;
        }

        .ooda-stage-icon.active {
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.5);
        }

        .ooda-stage-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .ooda-stage-count {
            font-size: 24px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.9);
        }

        .arrow {
            font-size: 24px;
            color: rgba(255, 255, 255, 0.4);
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>Kafka Observability Platform</h1>
            <div class="subtitle">Distributed Semiotic Intelligence with Promise Theory & Speech Act Theory</div>
        </div>
        <div class="connection-status">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Connecting...</span>
        </div>
    </div>

    <div class="container">
        <!-- OODA Loop Visualization -->
        <div class="ooda-flow">
            <div class="ooda-stage">
                <div class="ooda-stage-icon" id="observeIcon" style="border-color: #3b82f6;">üëÅÔ∏è</div>
                <div class="ooda-stage-name">OBSERVE</div>
                <div class="ooda-stage-count" id="observeCount">0</div>
            </div>
            <div class="arrow">‚Üí</div>
            <div class="ooda-stage">
                <div class="ooda-stage-icon" id="orientIcon" style="border-color: #8b5cf6;">üß≠</div>
                <div class="ooda-stage-name">ORIENT</div>
                <div class="ooda-stage-count" id="orientCount">0</div>
            </div>
            <div class="arrow">‚Üí</div>
            <div class="ooda-stage">
                <div class="ooda-stage-icon" id="decideIcon" style="border-color: #f59e0b;">üéØ</div>
                <div class="ooda-stage-name">DECIDE</div>
                <div class="ooda-stage-count" id="decideCount">0</div>
            </div>
            <div class="arrow">‚Üí</div>
            <div class="ooda-stage">
                <div class="ooda-stage-icon" id="actIcon" style="border-color: #10b981;">‚ö°</div>
                <div class="ooda-stage-name">ACT</div>
                <div class="ooda-stage-count" id="actCount">0</div>
            </div>
        </div>

        <!-- Sidecar Health Cards -->
        <div class="grid" id="sidecarGrid">
            <!-- Dynamically populated -->
        </div>

        <!-- Narrative Panel -->
        <div class="activity-stream" style="margin-bottom: 20px;">
            <h2>üìñ What's Happening</h2>
            <div id="narrative" style="padding: 20px; background: rgba(0,0,0,0.3); border-radius: 8px; line-height: 1.8;">
                <p><strong>Initial State:</strong> Monitoring producer-1 via JMX. Collecting buffer metrics every 10 seconds.</p>
                <p><strong>How to trigger signals:</strong> The producer is currently sending at configurable rate. Buffer overflow happens when send rate exceeds Kafka's ability to drain.</p>
                <p><strong>Signal Flow:</strong> JMX ‚Üí ProducerBufferMonitor ‚Üí Substrates Circuit ‚Üí Dashboard</p>
            </div>
        </div>

        <!-- Activity Stream -->
        <div class="activity-stream">
            <h2>
                <span>üî¥ Live Activity Stream</span>
                <span style="font-size: 14px; font-weight: normal; color: rgba(255,255,255,0.6);">(Raw signals)</span>
            </h2>
            <div id="activityFeed">
                <div style="text-align: center; color: rgba(255,255,255,0.5); padding: 40px;">
                    Waiting for signals...
                </div>
            </div>
        </div>

        <!-- Chaos Scenarios -->
        <div class="scenarios">
            <h2>üé≠ Chaos Engineering Scenarios</h2>
            <div class="scenario-grid">
                <button class="scenario-btn" onclick="triggerScenario('buffer-overflow')">
                    üìä Buffer Overflow<br>
                    <small style="opacity: 0.7;">Gradual producer buffer saturation</small>
                </button>
                <button class="scenario-btn" onclick="triggerScenario('broker-cpu-spike')">
                    üî• Broker CPU Spike<br>
                    <small style="opacity: 0.7;">stress-ng CPU saturation</small>
                </button>
                <button class="scenario-btn" onclick="triggerScenario('network-partition')">
                    üåê Network Partition<br>
                    <small style="opacity: 0.7;">Gradual latency increase (100ms‚Üí2s)</small>
                </button>
                <button class="scenario-btn" onclick="triggerScenario('consumer-lag')">
                    ‚è±Ô∏è Consumer Lag<br>
                    <small style="opacity: 0.7;">Slow consumer processing</small>
                </button>
                <button class="scenario-btn" onclick="triggerScenario('cascading-failure')">
                    ‚ö†Ô∏è Cascading Failure<br>
                    <small style="opacity: 0.7;">Multi-broker degradation</small>
                </button>
            </div>
        </div>
    </div>

    <script>
        let ws;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 10;

        // OODA counters
        const oodaCounts = {
            OBSERVE: 0,
            ORIENT: 0,
            DECIDE: 0,
            ACT: 0
        };

        // Sidecar health tracking
        const sidecars = new Map();

        function connect() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;

            console.log('Connecting to WebSocket:', wsUrl);
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('WebSocket connected');
                document.getElementById('statusDot').classList.add('connected');
                document.getElementById('statusText').textContent = 'Connected';
                reconnectAttempts = 0;
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('Received:', data);

                switch (data.type) {
                    case 'connection':
                        handleConnection(data);
                        break;
                    case 'signal':
                        handleSignal(data);
                        break;
                    case 'system-event':
                        handleSystemEvent(data);
                        break;
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected');
                document.getElementById('statusDot').classList.remove('connected');
                document.getElementById('statusText').textContent = 'Disconnected';

                // Attempt reconnection
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    console.log(`Reconnecting... (${reconnectAttempts}/${maxReconnectAttempts})`);
                    setTimeout(connect, 3000);
                }
            };
        }

        function handleConnection(data) {
            addActivityItem('System', 'Dashboard connected to observability platform', 'system');
        }

        function handleSignal(data) {
            const { entityId, data: signalData } = data;
            const signalType = signalData.type || 'SIGNAL';
            const signalStr = signalData.signal || '';

            // Count as OBSERVE layer
            oodaCounts.OBSERVE++;
            document.getElementById('observeCount').textContent = oodaCounts.OBSERVE;

            // Animate OBSERVE icon
            const icon = document.getElementById('observeIcon');
            icon.classList.add('active');
            setTimeout(() => icon.classList.remove('active'), 500);

            // Update sidecar health
            updateSidecarHealth(entityId, signalStr);

            // Update narrative
            updateNarrative(signalType, signalStr, entityId);

            // Add to activity feed
            addActivityItem(
                entityId,
                `${signalType}: ${signalStr}`,
                'observe'
            );
        }

        function updateNarrative(signalType, signalStr, entityId) {
            const narrative = document.getElementById('narrative');

            if (signalStr.includes('OVERFLOW')) {
                narrative.innerHTML = `
                    <p style="color: #f59e0b;"><strong>‚ö†Ô∏è BUFFER OVERFLOW DETECTED</strong></p>
                    <p><strong>What happened:</strong> Producer ${entityId} is sending messages faster than Kafka can drain them.</p>
                    <p><strong>Signal:</strong> Queue.OVERFLOW emitted via Substrates Circuit</p>
                    <p><strong>Meaning:</strong> Buffer utilization >95%. Producer will block soon if rate continues.</p>
                    <p><strong>Traditional monitoring:</strong> Would show metric "buffer.available.bytes" - requires YOU to interpret</p>
                    <p><strong>Semiotic monitoring:</strong> OVERFLOW signal carries MEANING - system understands the problem</p>
                    <p><strong>Next step:</strong> In full OODA loop, this would trigger ORIENT (assess severity) ‚Üí DECIDE (determine action) ‚Üí ACT (throttle producer or scale Kafka)</p>
                `;
            } else if (signalStr.includes('PUT') || signalStr.includes('ENQUEUE')) {
                narrative.innerHTML = `
                    <p><strong>‚úÖ Normal Operation</strong></p>
                    <p><strong>What's happening:</strong> Producer ${entityId} sending messages at normal rate.</p>
                    <p><strong>Signal:</strong> Queue.PUT - buffer accepting messages without pressure</p>
                    <p><strong>Buffer state:</strong> Healthy - messages draining to Kafka normally</p>
                    <p><strong>Semiotic difference:</strong> PUT vs OVERFLOW are different SIGNS with different MEANINGS, not just different metric values</p>
                `;
            }
        }

        function handleSystemEvent(data) {
            const { eventType, details } = data;
            addActivityItem('System', `${eventType}: ${JSON.stringify(details)}`, 'system');
        }

        function updateSidecarHealth(entityId, signalStr) {
            if (!sidecars.has(entityId)) {
                sidecars.set(entityId, {
                    id: entityId,
                    status: 'healthy',
                    lastSignal: Date.now(),
                    metrics: {}
                });
                renderSidecars();
            }

            const sidecar = sidecars.get(entityId);
            sidecar.lastSignal = Date.now();

            // Update status based on signal
            if (signalStr.includes('OVERFLOW') || signalStr.includes('DEGRADED')) {
                sidecar.status = 'degraded';
            } else if (signalStr.includes('CRITICAL') || signalStr.includes('DOWN')) {
                sidecar.status = 'critical';
            } else {
                sidecar.status = 'healthy';
            }

            renderSidecars();
        }

        function renderSidecars() {
            const grid = document.getElementById('sidecarGrid');
            grid.innerHTML = '';

            sidecars.forEach((sidecar) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <h3>
                        <span>üöÄ ${sidecar.id}</span>
                        <span class="badge ${sidecar.status}">${sidecar.status}</span>
                    </h3>
                    <div class="metric">
                        <span class="metric-label">Last Signal</span>
                        <span class="metric-value">${formatTime(Date.now() - sidecar.lastSignal)}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Autonomy Level</span>
                        <span class="metric-value">99%</span>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function addActivityItem(source, message, type) {
            const feed = document.getElementById('activityFeed');

            // Remove "waiting" placeholder if present
            if (feed.querySelector('[style*="Waiting"]')) {
                feed.innerHTML = '';
            }

            const item = document.createElement('div');
            item.className = `activity-item ${type}`;
            item.innerHTML = `
                <div class="activity-header">
                    <strong>${source}</strong>
                    <span class="activity-time">${new Date().toLocaleTimeString()}</span>
                </div>
                <div class="activity-details">${message}</div>
            `;

            feed.insertBefore(item, feed.firstChild);

            // Keep only last 50 items
            while (feed.children.length > 50) {
                feed.removeChild(feed.lastChild);
            }
        }

        function formatSignalDetails(signal) {
            if (signal.units !== undefined) {
                return `(${signal.units})`;
            }
            if (signal.condition) {
                return `[${signal.condition}]`;
            }
            return '';
        }

        function formatTime(ms) {
            if (ms < 1000) return `${ms}ms`;
            if (ms < 60000) return `${Math.floor(ms / 1000)}s`;
            return `${Math.floor(ms / 60000)}m`;
        }

        function triggerScenario(scenarioId) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('WebSocket not connected');
                return;
            }

            console.log('Triggering scenario:', scenarioId);
            ws.send(JSON.stringify({
                type: 'trigger-scenario',
                scenarioId: scenarioId
            }));

            // Visual feedback
            event.target.classList.add('running');
            setTimeout(() => event.target.classList.remove('running'), 3000);
        }

        // Initialize connection on page load
        connect();
    </script>
</body>
</html>
